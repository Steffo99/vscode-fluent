scopeName: source.ftl

patterns:
- include: "#comment-single"
- include: "#comment-double"
- include: "#comment-triple"
- include: "#message"
- include: "#term"
- include: "#attribute"
- include: "#junk"

repository:
  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L75
  comment-single:
    begin: >-
      ^(#(?!#))
    end: >-
      $
    name: comment.line.number-sign.single.fluent
    beginCaptures:
      1: 
        name: punctuation.definition.comment.number-sign.single.fluent
  
  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L75
  comment-double:
    begin: >-
      ^(##(?!#))
    end: >-
      $
    name: comment.line.number-sign.double.fluent
    beginCaptures:
      1: 
        name: punctuation.definition.comment.number-sign.double.fluent
  
  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L75
  comment-triple:
    begin: >-
      ^(###(?!#))
    end: >-
      $
    name: comment.line.number-sign.triple.fluent
    beginCaptures:
      1: 
        name: punctuation.definition.comment.number-sign.triple.fluent

  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L43
  message:
    match: >-
      ^\s*([a-zA-Z][a-zA-Z0-9_-]*)\s*(=)\s*(.+)$
    name: meta.message.fluent
    captures:
      1:
        name: meta.identifier.message.fluent
      2:
        name: keyword.operator.assignment.message.fluent
      3:
        name: meta.pattern.message.fluent
  
  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L60
  term:
    match: >-
      ^\s*(-)([a-zA-Z][a-zA-Z0-9_-]*)\s*(=)\s*(.+)$
    name: meta.term.fluent
    captures:
      1: 
        name: punctuation.definition.term.fluent
      2:
        name: meta.identifier.term.fluent
      3:
        name: keyword.operator.assignment.term.fluent
      4:
        name: meta.pattern.term.fluent
  
  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L126
  attribute:
    match: >-
      ^\s*(.)([a-zA-Z][a-zA-Z0-9_-]*)\s*(=)\s*(.+)$
    name: meta.attribute.fluent
    captures:
      1: 
        name: punctuation.definition.attribute.fluent
      2:
        name: meta.identifier.attribute.fluent
      3:
        name: keyword.operator.assignment.attribute.fluent
      4:
        name: meta.pattern.attribute.fluent

  placeable:
    begin: >-
      ({)
    end: >-
      (})
    beginCaptures:
      1:
        name: keyword.placeable.begin.fluent
    endCaptures:
      1:
        name: keyword.placeable.end.fluent
    contentName: variable.other.placeable.content.fluent
    patterns:
      - include: "#placeable-string"
      - include: "#placeable-function"
      - include: "#placeable-reference-or-number"
      - include: "#selector"
      - include: "#invalid-placeable-wrong-placeable-missing-end"
      - include: "#invalid-placeable-string-missing-end-quote"
      - include: "#invalid-placeable-wrong-function-name"

  placeable-reference-or-number:
    name: variable.other.placeable.reference-or-number.fluent
    match: "\
      (\
        (-|\\$)[a-zA-Z0-9_-]+|\
        [a-zA-Z][a-zA-Z0-9_-]*|\
        [0-9]+\
      )"

  placeable-function:
    begin: >-
      ([A-Z][A-Z0-9_-]*\()
    end: >-
      (\))
    beginCaptures:
      1:
        name: support.function.placeable-function.call.begin.fluent
    endCaptures:
      1:
        name: support.function.placeable-function.call.end.fluent
    contentName: string.placeable-function.fluent
    patterns:
      - include: "#function-comma"
      - include: "#function-positional-argument"
      - include: "#function-named-argument"

  function-comma:
    name: support.function.function-comma.fluent
    match: >-
      ,

  function-positional-argument:
    name: variable.other.function.positional-argument.fluent
    match: >-
      \$[a-zA-Z0-9_-]+

  function-named-argument:
    begin: >-
      ([a-zA-Z0-9]+:)\s*(["a-zA-Z0-9]+)
    end: >-
      (?=\)|,|\s)
    beginCaptures:
      1:
        name: support.function.named-argument.name.fluent
      2:
        name: variable.other.named-argument.value.fluent
    name: variable.other.named-argument.fluent

  placeable-string:
    begin: >-
      (")(?=[^\n]*")
    end: >-
      (")
    beginCaptures:
      1:
        name: variable.other.placeable-string-begin.fluent
    endCaptures:
      1:
        name: variable.other.placeable-string-end.fluent
    contentName: string.placeable-string-content.fluent

  selector:
    begin: >-
      (->)
    end: >-
      ^(?=\s*})
    beginCaptures:
      1:
        name: support.function.selector.begin.fluent
    contentName: string.selector.content.fluent
    patterns:
      - include: "#selector-item"

  selector-item:
    begin: >-
      (\s*\*?\[)([a-zA-Z0-9_-]+)(\]\s*)
    end: "\
      ^(?=\
        (\\s*})|\
        (\\s*\\[)|\
        (\\s*\\*)\
      )"
    beginCaptures:
      1:
        name: support.function.selector-item.begin.fluent
      2:
        name: variable.other.selector-item.begin.fluent
      3:
        name: support.function.selector-item.begin.fluent
    contentName: string.selector-item.content.fluent
    patterns:
      - include: "#placeable"

  # https://github.com/projectfluent/fluent/blob/10a1bc60bee843c14a30216fa4cebdc559bf2076/syntax/grammar.js#L103
  junk:
    begin: >-
      ^
    end: >-
      [\n\u000A]$
    name: invalid.illegal.junk.line.fluent

  invalid-placeable-wrong-placeable-missing-end:
    name: invalid.illegal.wrong-placeable-missing-end.fluent
    match: >-
      ([^}A-Z]*$|[^-][^>]$)\b

  invalid-placeable-string-missing-end-quote:
    name: invalid.illegal.wrong-placeable-missing-end-quote.fluent
    match: >-
      "[^"]+$
